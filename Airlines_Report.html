<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Airlines Market Report (Professional)</title>

    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap"
        rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">

    <style>
        :root {
            --bg-body: #f1f5f9;
            --bg-card: #ffffff;
            --text-primary: #0f172a;
            --text-secondary: #64748b;
            --accent-blue: #3b82f6;
            --pos-bg: #dcfce7;
            --pos-text: #166534;
            --neg-bg: #fee2e2;
            --neg-text: #991b1b;
            --neu-bg: #f1f5f9;
            --neu-text: #475569;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-primary);
            padding-bottom: 60px;
        }

        .page-header {
            padding: 2rem 0;
            margin-bottom: 1rem;
        }

        .page-title {
            font-weight: 800;
            color: #1e293b;
            letter-spacing: -0.025em;
        }

        .page-subtitle {
            color: var(--text-secondary);
        }

        .dashboard-card {
            background: var(--bg-card);
            border-radius: 16px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
            height: 100%;
        }

        .table-card {
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid #e2e8f0;
            background: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        .table-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid #e2e8f0;
            background: white;
        }

        table.dataTable thead th {
            background-color: #f8fafc !important;
            color: #475569;
            font-weight: 600;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 1px solid #e2e8f0 !important;
        }

        table.dataTable tbody td {
            vertical-align: middle;
            font-size: 0.9rem;
            padding: 1rem !important;
            color: #334155;
        }

        .badge-pct {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 68px;
            padding: 6px 10px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .pct-pos {
            background-color: var(--pos-bg);
            color: var(--pos-text);
        }

        .pct-neg {
            background-color: var(--neg-bg);
            color: var(--neg-text);
        }

        .pct-neu {
            background-color: var(--neu-bg);
            color: var(--neu-text);
        }

        .badge-pct:hover {
            filter: brightness(0.96);
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .symbol-badge {
            background-color: #eff6ff;
            color: var(--accent-blue);
            padding: 4px 8px;
            border-radius: 6px;
            font-weight: 700;
            font-size: 0.85rem;
        }

        #chartTooltip {
            position: fixed;
            display: none;
            width: 380px;
            min-height: 280px;
            background: #ffffff;
            border: 1px solid #cbd5e1;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            z-index: 9999;
            border-radius: 16px;
            padding: 20px;
            pointer-events: none;
        }

        #tooltipHeader {
            border-bottom: 2px solid #f1f5f9;
            margin-bottom: 10px;
            padding-bottom: 10px;
        }

        #chartContainer {
            width: 100%;
            height: 150px;
            margin-top: 5px;
        }
    </style>
</head>

<body>

    <div class="container main-container">
        <div class="page-header row align-items-end">
            <div class="col-md-8">
                <h1 class="page-title">Airlines Market Report</h1>
                <p class="page-subtitle">Interactive market analysis dashboard & visualization</p>
            </div>
            <div class="col-md-4 text-md-end">
                <button class="btn btn-outline-secondary btn-sm" onclick="window.print()">Export PDF</button>
            </div>
        </div>

        <div class="row g-4 mb-4">
            <div class="col-lg-8">
                <div class="dashboard-card d-flex flex-column">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="fw-bold mb-0" style="color: #334155;">Market Cap Distribution</h5>
                        <span class="badge bg-light text-secondary">Top 5 vs Others</span>
                    </div>
                    <div id="marketCapChart" class="flex-grow-1" style="min-height: 300px;"></div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="dashboard-card">
                    <h5 class="fw-bold mb-3" style="color: #334155;">Settings</h5>
                    <div class="mb-3">
                        <label class="form-label text-secondary small fw-bold">PERFORMANCE TIMEFRAME</label>
                        <select id="tfSelector" class="form-select form-select-lg">
                            <option value="1D">1 Day</option>
                            <option value="1M">1 Month</option>
                            <option value="2M">2 Months</option>
                            <option value="3M">3 Months</option>
                            <option value="6M">6 Months</option>
                            <option value="12M">1 Year</option>
                            <option value="YTD">YTD</option>
                        </select>
                    </div>
                    <div class="p-3 bg-light rounded-3 border mt-4">
                        <small class="text-muted d-block mb-1"><strong>Pro Tip:</strong></small>
                        <span style="font-size: 0.9rem; color: #475569;">
                            Hover over any % value in the table to see the price trend chart.
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <div class="table-card mb-5">
            <div class="table-header">
                <h5 class="fw-bold mb-0" style="color: #334155;">Detailed Market Data</h5>
            </div>
            <div class="table-responsive">
                <table id="stocksTable" class="table mb-0" style="width:100%">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Symbol</th>
                            <th>Company</th>
                            <th>Market Cap</th>
                            <th>P/E</th>
                            <th class="tf-1D">1D %</th>
                            <th class="tf-1M">1M %</th>
                            <th class="tf-2M">2M %</th>
                            <th class="tf-3M">3M %</th>
                            <th class="tf-6M">6M %</th>
                            <th class="tf-12M">12M %</th>
                            <th class="tf-YTD">YTD %</th>
                            <th>Volume</th>
                            <th>Revenue</th>
                        </tr>
                    </thead>
                    <tbody id="stocksTableBody">
                        <!-- Dynamic rows will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="chartTooltip">
        <div id="tooltipHeader"></div>
        <div id="chartContainer"></div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

    <script>
        var stockData = {};
        var tooltipChart = null;

        async function loadData() {
            try {
                const response = await fetch('http://127.0.0.1:8000/api/industry/Airlines');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();

                if (data.metadata) {
                    console.log("SERVER METADATA:", data.metadata);
                }

                data.stocks.forEach(s => { stockData[s.symbol] = s.history; });

                const tbody = $('#stocksTableBody');
                tbody.empty();
                data.stocks.forEach((s, idx) => {
                    const row = `
                        <tr>
                            <td>${idx + 1}</td>
                            <td><span class="symbol-badge">${s.symbol}</span></td>
                            <td class="fw-medium">${s.company}</td>
                            <td data-order="${s.market_cap}">$${(s.market_cap / 1e9).toFixed(2)}B</td>
                            <td>${s.pe_ratio ? s.pe_ratio.toFixed(1) : '-'}</td>
                            ${renderPctCell(s.symbol, '1D', s.change_1d)}
                            ${renderPctCell(s.symbol, '1M', s.change_1m)}
                            ${renderPctCell(s.symbol, '2M', s.change_2m)}
                            ${renderPctCell(s.symbol, '3M', s.change_3m)}
                            ${renderPctCell(s.symbol, '6M', s.change_6m)}
                            ${renderPctCell(s.symbol, '12M', s.change_12m)}
                            ${renderPctCell(s.symbol, 'YTD', s.change_ytd)}
                            <td>${s.volume ? (s.volume / 1e6).toFixed(1) + 'M' : '-'}</td>
                            <td>${s.revenue ? '$' + (s.revenue / 1e9).toFixed(1) + 'B' : '-'}</td>
                        </tr>
                    `;
                    tbody.append(row);
                });

                const table = $('#stocksTable').DataTable({
                    pageLength: 25, order: [[3, 'desc']],
                    columnDefs: [{ targets: [6, 7, 8, 9, 10, 11], visible: false }]
                });

                $('#tfSelector').on('change', function () {
                    const val = $(this).val();
                    const map = { '1D': 5, '1M': 6, '2M': 7, '3M': 8, '6M': 9, '12M': 10, 'YTD': 11 };
                    table.columns([5, 6, 7, 8, 9, 10, 11]).visible(false);
                    table.column(map[val]).visible(true);
                });

                initDonutChart(data.donut_data);
            } catch (err) {
                $('#stocksTableBody').html('<tr><td colspan="14" class="text-center text-danger py-4">Error: ' + err.message + '</td></tr>');
            }
        }

        function renderPctCell(symbol, tf, val) {
            if (val === null || val === undefined) return `<td class="tf-${tf}">-</td>`;
            const cls = val > 0 ? 'pct-pos' : (val < 0 ? 'pct-neg' : 'pct-neu');
            const sign = val > 0 ? '+' : '';
            return `<td class="tf-${tf}"><span class="badge-pct ${cls} chart-trigger" data-symbol="${symbol}" data-tf="${tf}">${sign}${val.toFixed(1)}%</span></td>`;
        }

        function initDonutChart(donutData) {
            if (!donutData || !donutData.series || donutData.series.length === 0) {
                $('#marketCapChart').html('<div class="text-center text-muted py-5">No Market Cap Data</div>');
                return;
            }
            var options = {
                series: donutData.series,
                labels: donutData.labels,
                chart: { type: 'donut', height: 320, fontFamily: 'Inter, sans-serif' },
                colors: ['#3b82f6', '#60a5fa', '#93c5fd', '#bfdbfe', '#2563eb', '#cbd5e1'],
                plotOptions: {
                    pie: {
                        donut: {
                            size: '72%',
                            labels: {
                                show: true,
                                name: { show: true, fontSize: '15px', fontWeight: 600, color: '#64748b' },
                                value: {
                                    show: true, fontSize: '22px', fontWeight: 800, color: '#1e293b',
                                    formatter: function (val, opts) {
                                        var total = opts.globals.seriesTotals.reduce((a, b) => a + b, 0);
                                        return ((val / total) * 100).toFixed(1) + "%";
                                    }
                                },
                                total: {
                                    show: true, label: 'TOTAL CAP', fontSize: '12px', fontWeight: 700, color: '#64748b',
                                    formatter: w => "$" + (w.globals.seriesTotals.reduce((a, b) => a + b, 0) / 1e9).toFixed(1) + "B"
                                }
                            }
                        }
                    }
                },
                dataLabels: { enabled: false },
                legend: { position: 'bottom', fontSize: '13px', markers: { radius: 12 } },
                tooltip: {
                    y: {
                        formatter: val => "$" + (val / 1e9).toFixed(2) + "B",
                        title: { formatter: (seriesName) => seriesName + ":" }
                    }
                }
            };
            new ApexCharts(document.querySelector("#marketCapChart"), options).render();
        }

        $(document).ready(function () {
            loadData();

            $('#stocksTable').on('mouseenter', '.chart-trigger', function (e) {
                var symbol = $(this).data('symbol');
                var tf = $(this).data('tf');
                var allData = stockData[symbol];
                if (!allData || allData.length < 2) return;

                // --- Precision Calendar Slicing ---
                var latestPt = allData[allData.length - 1];
                var parts = latestPt.x.split('-').map(Number);
                var ty = parts[0], tm = parts[1], td = parts[2];
                var monthsMap = { '1M': 1, '2M': 2, '3M': 3, '6M': 6, '12M': 12 };

                if (tf === 'YTD') { tm = 1; td = 1; }
                else if (tf !== '1D') {
                    tm -= (monthsMap[tf] || 1);
                    while (tm <= 0) { tm += 12; ty--; }
                    var maxD = new Date(ty, tm, 0).getDate();
                    if (td > maxD) td = maxD;
                }
                var tDateStr = (tf === '1D') ? '' : `${ty}-${tm.toString().padStart(2, '0')}-${td.toString().padStart(2, '0')}`;

                var filteredData = [];
                var isConflict = false;
                if (tf === '1D') filteredData = allData.slice(-2);
                else {
                    var startIdx = -1;
                    for (var i = allData.length - 1; i >= 0; i--) {
                        if (allData[i].x <= tDateStr) { startIdx = i; break; }
                    }
                    if (startIdx === -1 || (startIdx === 0 && allData[0].x > tDateStr)) {
                        isConflict = true; filteredData = allData;
                    } else filteredData = allData.slice(startIdx);
                }

                var valText = $(this).text().trim();
                var color = $(this).hasClass('pct-pos') ? '#166534' : '#991b1b';

                // Redesigned Header
                $('#tooltipHeader').html(`
                    <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                        <div>
                            <div style="font-size:1.1rem; font-weight:800; color:#0f172a;">${symbol} <span style="font-weight:400; color:#64748b; font-size:0.85rem;">(${tf})</span></div>
                            <div style="font-size:0.7rem; color:#64748b; margin-top:2px;">Data Points: ${filteredData.length}</div>
                        </div>
                        <div style="text-align:right;">
                            <div style="font-size:1.25rem; font-weight:800; color:${color}; line-height:1;">${valText}</div>
                            <div style="font-size:0.7rem; color:#64748b; margin-top:6px; line-height:1.2;">
                                Start: ${filteredData[0].x} (<b>$${filteredData[0].y.toFixed(2)}</b>)<br>
                                End: &nbsp;${filteredData[filteredData.length - 1].x} (<b>$${filteredData[filteredData.length - 1].y.toFixed(2)}</b>)
                            </div>
                        </div>
                    </div>
                    ${isConflict ? '<div style="color:#ef4444; font-size:0.75rem; font-weight:700; border-top:1px solid #fee2e2; margin-top:8px; padding-top:6px; text-transform:uppercase;">âš  Conflict: History too short. Restart API Server.</div>' : ''}
                `);

                var options = {
                    series: [{ name: 'Price', data: filteredData }],
                    chart: { type: 'area', height: 150, sparkline: { enabled: true }, animations: { enabled: false } },
                    stroke: { curve: 'smooth', width: 2.5, colors: [color] },
                    fill: { type: 'gradient', gradient: { opacityFrom: 0.35, opacityTo: 0.05 } },
                    colors: [color], tooltip: { enabled: false },
                    yaxis: {
                        min: Math.min(...filteredData.map(d => d.y)) * 0.997,
                        max: Math.max(...filteredData.map(d => d.y)) * 1.003
                    },
                    grid: { padding: { left: 5, right: 5, top: 0, bottom: 0 } }
                };

                if (tooltipChart) tooltipChart.destroy();
                tooltipChart = new ApexCharts(document.querySelector("#chartContainer"), options);
                tooltipChart.render();
                $('#chartTooltip').fadeIn(100);
            });

            $(document).on('mousemove', function (e) {
                if ($('#chartTooltip').is(':visible')) {
                    var tX = e.clientX + 20, tY = e.clientY + 20;
                    if (tX + 380 > window.innerWidth) tX = e.clientX - 380;
                    if (tY + 300 > window.innerHeight) tY = e.clientY - 300;
                    $('#chartTooltip').css({ top: tY, left: tX });
                }
            });

            $('#stocksTable').on('mouseleave', '.chart-trigger', function () { $('#chartTooltip').hide(); });
        });
    </script>
</body>

</html>